<?php

namespace Controller;
use Exception\InvalidLoginOrPasswordException;
use Arbor\Core\Controller;
use Arbor\Provider\Response;

class Authenticate extends Controller{
	
	public function login(){
		$request=$this->getRequest();
		if($request->getType()=='POST'){
			$data=$request->getData();
			$user=$this->findOne('User',array('login'=>$data['login']));
			if(!$user)
				throw new InvalidLoginOrPasswordException();

			$hash=$this->getService('salt')->encode($data['password'],$user->getSalt());
			if($hash!=$user->getPassword())
				throw new InvalidLoginOrPasswordException();

			$session=$this->getRequest()->getSession();

			$session->set('user.id',$user->getId());

			$response=new Response();
			$response->redirect("/");
			return $response;

		}

	
	}

	public function logout(){
		$this->getRequest()->getSession()->clear();
		$response=new Response();
		$response->redirect("/");
		return $response;
	}
}